## 上下文
- 当前实现以“编辑器优先”为主：Markdown/代码文件大量走 Monaco；tasks.md 走独立看板。
- 目标升级为 Typora 风格：默认渲染、就地改字、最小语法暴露，同时要求尽量保留原始字节风格。

## 目标 / 非目标
- 目标：Markdown 默认渲染视图，双击语义单元即可编辑，体验接近 Typora。
- 目标：仅必要时显示 Markdown 语法符号（光标所在行/冲突风险/显式源码编辑）。
- 目标：保存时尽量保持 BOM / 换行风格 / 未触及区域的原文不变。
- 目标：tasks.md 默认看板，但编辑与保存必须与源 Markdown 同源、可撤销、可追踪。
- 非目标：一次性覆盖所有 Markdown 边角（复杂嵌套表格/引用内多级列表等允许分阶段支持）。
- 非目标：强行保证“绝对字节级不变”（例如用户确实改动该行时，行内空格/换行可能必然变化），但必须做到“最小改动面”。

## 核心决策（最完美路线）
1) **源文本是唯一真相**：任何编辑最终都归结为对 Markdown 文本的精确 patch，而不是“结构化文档 -> 重新序列化 Markdown”的全局重排。
2) **编辑引擎采用“文本 + 装饰层”体系**：使用 CodeMirror 6 的 state/transaction/decoration 模型维护视图投影与编辑行为。
   - 这样可以在不改变底层文本的前提下，渲染标题、列表、任务 checkbox、链接样式等，并控制语法符号显隐。
3) **语义双击 = 语义选区**：双击不只是选词，而是按语义扩展（链接文本、强调范围、列表项文本、代码片段等），并进入就地编辑。
4) **必要时显示语法**：默认隐藏/弱化语法符号；当光标进入某行或编辑可能破坏结构时自动显现该行相关语法。
5) **tasks.md 作为 Markdown 子集处理**：看板只是“结构视图”，所有勾选/改名/改描述都映射成对源文本的最小 patch，并通过同一撤销栈统一。

## 技术方案（组件分层）
- MarkdownSurface（新）：承载 CodeMirror 6 编辑核心与 decorations。
  - 负责：渲染投影、语义选区、局部编辑、撤销/重做、查找（Ctrl+F）等。
- TaskBoard（保留/改造）：作为 MarkdownSurface 的结构化视图。
  - 负责：展示统计、分组、过滤；编辑动作转成对 MarkdownSurface 的 patch。
- FilePersistence（复用现有能力）：读取时保留 encoding/BOM/EOL 元信息；保存时按原风格输出。

## 迭代策略（每步都通往终点）
- P0：把 Markdown 文件接入 CodeMirror 6（文本为真相），先稳定输入法/撤销/保存/查找。
- P1：实现“语义双击选区 + 就地编辑”，并落地“必要时显示语法”的规则（先覆盖标题/段落/列表/任务）。
- P2：tasks.md 看板与 MarkdownSurface 同源（点击勾选、改标题、改描述都走统一 patch）。
- P3：扩展到表格/引用/复杂嵌套列表/代码块等，并补齐性能（只对可视区域计算 decorations）。

## 语义单元定义表（双击选区）

说明：双击优先选中“可见文本”的语义单元。必要时显示语法符号以允许修改，但默认不把语法符号纳入选区。

| 语义单元 | 例子（Markdown） | 双击应选中 | 编辑落点与最小 patch | 语法显隐策略（必要时） |
|---|---|---|---|---|
| 段落文本 | `这是一个段落` | 当前词/句的可见文本范围（按语义扩展） | 就地编辑替换该范围；不改行首/行尾空白 | 一般不显示；若涉及换行/断词边界则显示该行必要符号 |
| 标题 | `## 标题` | 标题可见文本 | 仅替换标题文本部分，保留 `#` 数量与后随空格 | 编辑行显示 `## ` 前缀（弱化） |
| 普通列表项 | `- 列表项` | 列表项可见文本（不含 `- `） | 仅替换列表文本，保留 marker 与缩进 | 编辑行显示 marker 与缩进（弱化） |
| 任务列表项 | `- [ ] 任务` | `任务` 可见文本 | 修改任务文本不动 `[ ]/[x]`；勾选只改状态位 | 编辑行显示 `- [ ] `（弱化） |
| 链接文本 | `[文字](url)` | `文字` | 修改文字不动 `(url)`；若用户触达链接结构则升级编辑粒度 | 默认隐藏括号结构；必要时显示整个链接语法并允许降级编辑 |
| 强调（粗体/斜体） | `**加粗**` / `*斜体*` | `加粗` / `斜体` | 修改内部文本；保留包裹符号数量与类型 | 默认不显示包裹符；光标进入时显示 `**`/`*`（弱化） |
| 行内代码 | `` `code` `` | `code` | 修改内部文本；尽量保留反引号数量（必要时增减以避免冲突） | 光标进入时显示反引号边界（弱化） |
| 代码块（fence） | ``` ```lang\n...\n``` ``` | 整个代码块内容（按行） | 进入块编辑；保留 fence 与语言标记 | 默认渲染为代码块；进入编辑时显示 fence（弱化） |
| 表格单元格 | `| a | b |` | 当前 cell 文本 | 优先 cell 内编辑；若出现 `|` 冲突则升级为行编辑或片段编辑 | 编辑时显示分隔符（弱化） |
| 引用块 | `> 引用` | 引用内可见文本 | 仅替换引用文本；保留 `> ` 与缩进 | 编辑行显示 `> `（弱化） |

备注：
- 语义优先级：链接文本 > 强调文本 > 行内代码 > 任务/列表项文本 > 标题文本 > 段落文本。
- “语义扩展”指：双击从落点开始，向外扩展到最近的语义边界（链接文本边界、强调边界、列表项文本边界等）。

## 降级策略（保证可编辑与可预测）

目标：在复杂结构或无法安全定位时，不要“瞎改”，而是明确降级到更粗粒度的编辑方式。

降级层级（从优到劣）：
1) 语义单元就地编辑：只替换语义范围，最小改动面。
2) 行编辑：无法可靠分离语法与文本时，编辑整行（仍尽量保持行首 marker/缩进）。
3) 块编辑：代码块/表格行/复杂嵌套列表等，编辑整个 block 的源码片段。
4) 全文源码编辑（兜底）：进入源码编辑器对整文件编辑；仅在用户明确触发或结构严重冲突时使用。

触发降级的典型条件：
- 语义边界不闭合或不一致（例如不成对的 `**`、破损链接括号）。
- 用户修改导致结构必然改变（例如删掉 `](` 使链接失效）。
- 表格/代码块中出现会破坏语法的冲突字符，且无法用局部转义解决。
- 双击命中区域跨越多个语义单元（例如强调内又包含链接）。

降级时的交互要求：
- 明确告诉用户当前已降级（例如轻提示：“已进入行编辑/块编辑”）。
- 降级编辑仍应保留撤销/重做、最小改动面保存与 BOM/EOL 保持策略。

## 必要时显示语法（触发条件 / 显示范围 / 退出条件）

目标：默认提供“像文档一样好读”的渲染观感，但在用户真正需要编辑时，及时暴露最小必要的 Markdown 语法，避免结构被误改。

### 定义
- **语法符号**：用于承载结构含义的 Markdown 片段，例如 `#`、`-`、`> `、`[ ]`、`**`、`` ` ``、`[]()`、fence ``` 等。
- **可见文本**：用户在渲染视图看到的文本内容，不包含被弱化/隐藏的语法符号。
- **编辑上下文**：当前光标所在语义单元 + 其所在行/块的结构约束（如列表层级、引用、表格行）。

### 触发条件（何时显示）

T1. **进入编辑**（必触发）
- 用户开始就地编辑（键入、粘贴、Backspace/Delete 修改）时。
- 用户通过双击语义单元进入编辑态时（落点已确定）。

T2. **结构敏感区域**（条件触发）
- 光标所在行是以下任一类型：标题、列表项、任务项、引用行、表格行、代码 fence 起止行。
- 用户的编辑操作可能跨越语义边界：例如从强调文本扩展选择、试图删除链接边界、在表格 cell 内输入 `|`。

T3. **冲突/不完整语法**（必触发）
- 解析发现语法边界不闭合或存在歧义：例如不成对的 `**`、破损链接 `](`、fence 未闭合。

T4. **用户显式请求**（必触发）
- 用户触发“显示源码片段/行编辑/块编辑”入口（降级路径）。

### 显示范围（显示到哪里）

R1. **最小范围：当前语义单元所在行**
- 默认只显示光标所在行的相关语法符号。
- 例：列表项显示 marker 与缩进；标题显示 `## `；引用显示 `> `；任务项显示 `- [ ] `。

R2. **扩展范围：当前语义单元的边界符**
- 若语义单元由边界符包裹（强调、行内代码、链接文本），显示其左右边界符，但不强制选中边界符。

R3. **块范围：结构必须成对时**
- 代码 fence：显示起止 fence（至少起止行），避免用户只见中间导致闭合被误删。
- 表格：当在 cell 内编辑可能破坏列对齐时，显示该行的 `|` 分隔符（弱化）。

R4. **降级范围**
- 进入行编辑：显示整行源码（但保留对 marker 的保护策略）。
- 进入块编辑：显示整块源码片段（代码块/表格行/复杂嵌套列表）。

### 退出条件（何时隐藏）

E1. **离开编辑上下文**
- 光标移出当前行/块，且当前行无语法冲突（闭合正常），隐藏该行语法符号，回到渲染观感。

E2. **空闲超时（可选）**
- 用户停止输入一定时间（例如 800ms），若光标仍在同一行但无冲突，可弱化显示强度（例如降低 alpha），不直接隐藏。

E3. **冲突未解决时不退出**
- 若处于 T3（冲突/不闭合）状态，必须保持显示，直到语法恢复可解析或用户显式降级处理。

### 保护策略（防止误改结构）
- 在 R1/R2 下，对关键结构符号提供“保护”：
  - 例如列表 marker、任务 `[ ]/[x]` 的固定区段，默认不允许光标进入；只有用户显式进入“行编辑/块编辑”才允许改动。
- 当用户尝试删除结构符号时，优先提示并建议降级，而不是默默修改造成结构破坏。

## tasks.md 看板与源文本映射规则（最小 patch + 可撤销）

目标：tasks.md 的看板视图只是“结构化展示”，编辑的唯一真相仍是源 Markdown 文本。看板上的任何操作都必须被映射为对源文本的**最小改动面** patch，并进入统一的撤销/重做栈。

### 术语
- **任务行**：满足任务语法的行，例如 `- [ ] xxx`、`- [x] xxx`（允许前置缩进）。
- **任务文本**：任务行中 checkbox 之后的可见文本部分（不包含 `- [ ] ` 与缩进）。
- **章节行**：看板中用于分组的标题行（通常来自 `##`/`###`）。
- **映射键**：用于把“看板中的某个任务项”稳定映射到“源文本中的具体行”的标识。

### 映射键（定位策略）

必须采用“先稳后准”的两段式定位，避免仅靠文本匹配导致错行：
1) **主键：行号锚点（Line Anchor）**
   - 初次打开 tasks.md 时，为每个任务行记录其源文本的行号（0-based/1-based 由实现决定，但必须统一）。
   - 当仅发生局部 patch 时，行号锚点通过增量更新保持同步（插入/删除行会影响后续锚点）。
2) **副键：内容指纹（Content Fingerprint）**
   - 为任务行计算一个轻量指纹，用于锚点失效时的回退匹配：
     - 指纹建议由：缩进层级、checkbox 状态、任务文本去首尾空白后的内容、可选的章节上下文组成。
   - 回退匹配必须在“章节范围”内优先查找，避免跨章节误匹配。

降级定位：
- 若主键与副键均无法唯一定位，必须降级为“行编辑/块编辑”，不允许盲目写回。

### 看板数据来源（解析规则）
- tasks.md 解析必须基于源文本逐行解析，输出看板需要的结构：
  - 章节（##/###）
  - 任务行（- [ ]/- [x]）
  - 任务描述（紧随任务行的连续缩进/引用/段落行，直到下一个任务行或章节行）
- 解析结果必须保留每个可写回单元对应的源文本范围：
  - 任务行：单行范围
  - 任务描述：多行范围（可为空）

### 最小 patch 规则（写回策略）

P1. 勾选/取消勾选（checkbox）
- 只允许改动任务行中 `[ ]` 与 `[x]` 的一个字符位：
  - `[ ]` ⇄ `[x]`（或 `[X]` 由实现统一小写）
- 不允许触碰行首缩进、`- `、任务文本与行尾空白。

P2. 修改任务文本（标题）
- 只替换 checkbox 之后的“任务文本”区域。
- 保留行首缩进、列表 marker、checkbox 片段、以及原行的换行符风格。
- 默认不改行尾多余空白；若用户输入包含行尾空白，则按输入结果写回。

P3. 修改任务描述
- 任务描述被视为任务的“多行块”，patch 只替换该块范围。
- 若任务原本无描述而用户新增描述：
  - 插入位置：紧随任务行之后。
  - 缩进规则：至少与该任务行的缩进层级一致；推荐额外缩进 2 空格或 4 空格以与常见 Markdown 约定一致（实现需固定一套）。
- 若用户删除描述：只删除描述块，不应影响相邻任务行与章节。

P4. 新增/删除任务（若未来支持）
- 新增任务：插入新任务行（及可选描述块），插入点由 UI 选择决定；必须保持章节内顺序。
- 删除任务：删除任务行 + 其描述块；不做其他重排。

### 可撤销（Undo/Redo）要求
- 看板的每次操作必须转成一次可撤销的“文本事务”（transaction）：
  - 勾选：单步撤销
  - 改标题：按一次确认（Enter/blur/save）作为一个事务
  - 改描述：同上
- 撤销/重做后，看板必须基于最新文本重新解析并刷新映射锚点。

### 与语义就地编辑的关系
- 在渲染视图中对 tasks.md 做语义就地编辑时，仍使用同一套“范围 -> patch”的原则。
- 看板与渲染视图必须共享同一份源文本状态，不允许各自维护独立内容缓存。

## 渲染视图行号（设计与实现约束）

目标：用户在渲染视图中“看得到行号”，并且行号能和源文本对应，方便你在指导时说“某文件第 N 行”用户能立刻定位。

### 展示形态
- 行号展示为内容区左侧 gutter（类似编辑器），与内容同滚动。
- 行号列宽固定（按最大行号位数计算），不因内容缩放抖动。
- 行号不参与选区与复制：复制时不应混入行号字符。

### 行号与源文本的映射
- 行号必须对应**源文本行号**（1-based 显示）。
- 渲染视图会发生折行：行号只显示一次，且与该源行的首个视觉行顶部对齐。

实现约束（纠偏后的主路线）：
1) MarkdownSurface 的“渲染视图”仍使用同一个编辑视图（EditorView），通过 decorations 提供“像 Typora 一样”的观感与语法显隐。
2) 行号直接使用 gutter 行号能力（lineNumbers）：
   - 天然与源文本行号对齐（1-based 展示由 UI 决定），折行只显示一次。
   - gutter 不参与选区与复制，不需要额外规避“复制混入行号”的问题。
3) 滚动同步：
   - 以 EditorView 的 scrollDOM 作为唯一滚动容器，gutter 跟随滚动即可。
   - 不再做 DOM data-line 锚点映射，避免复杂度与布局抖动。
4) 性能：
   - 行号布局与滚动由编辑器内建处理；开关切换/字体变化时触发一次重布局即可。

### 开关与持久化
- 提供“显示行号”开关（默认关闭或跟随上次设置，由产品决定）。
- 开关状态应持久化到偏好设置（与主题、面板宽度同一套机制）。

### 与就地编辑/降级编辑的兼容
- 默认渲染视图显示行号。
- 进入就地编辑时行号可以继续显示，但不得改变编辑器宽度导致内容抖动。
- 进入“全文源码编辑”（若未来存在）时，可复用编辑器自身的 gutter 行号能力，不需要重复实现。

## 风险 / 权衡
- Markdown 结构边角复杂：必须定义“支持矩阵 + 降级策略”（无法语义定位时退回源码块编辑）。
- 大文档 decorations 成本：需按可视区域增量计算，避免全量重绘。
- 与现有 Monaco 共存：短期可并行；中期建议 Markdown 统一到 CodeMirror 6，代码文件保留 Monaco。

## 迁移计划
- 新功能先仅对 Markdown（含 tasks.md）生效，非 Markdown 维持现状。
- 完成 P2 后再决定是否把更多文本类型纳入同一体验。

## 待决问题（已由用户确认）
- 语法显隐：**必要时显示**（已确认）
- 双击语义：**双击选中语义单元**（已确认）
